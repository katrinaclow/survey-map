<!DOCTYPE html>
<html>
<head>
    <title>Job Map</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Load Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Load Leaflet.markercluster CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }

        #yearSelector {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    // Initialize the map and set its view to your desired location
    var map = L.map('map').setView([46.45, -63.30], 9); // Example: Ottawa coordinates

    // Initialize control layers for map toggling
    var controlLayers = L.control.layers(null, null, {position: "topright", collapsed: false}).addTo(map);

    const yearLayers = {};
    let selectedYear = 'all';  // Track the selected year
    // Define base map layers
    const baseMaps = {
        "Basic": L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map),

        "Topographical": L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: 'Map data &copy; OpenStreetMap contributors, SRTM | Style: OpenTopoMap',
        }),

        "Satellite": L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
            attribution: "Tiles &copy; Esri",
        }),
    };

    // Add the base maps to the control
    Object.entries(baseMaps).forEach(([name, layer]) => {
        controlLayers.addBaseLayer(layer, name);
    });

    // Define custom completed icon
    const completedIcon = L.icon({
        iconUrl: "https://clipart-library.com/images_k/red-check-mark-transparent-background/red-check-mark-transparent-background-22.png",
        iconSize: [20, 16],  // Smaller size for completed marker
        iconAnchor: [8, 8],  // Center the smaller icon
        popupAnchor: [0, -8]
    });

    // Function to generate popup content for a job marker
    function createPopupContent(properties) {
        return `
    <h1> ${properties.job_number}</h1>
    <p><strong>Client:</strong> ${properties.client}</p>
    <p><strong>Address:</strong> ${properties.address}</p>
    <p><strong>PID:</strong> ${properties.pid}</p>
    <p><strong>Fieldwork Completed:</strong> ${properties.initial_fieldwork_completed || "N/A"}</p>
    <p><strong>Survey Markers Set:</strong> ${properties.survey_markers_set || "N/A"}</p>
    <p><strong>Final Plan Submitted:</strong> ${properties.final_plan_submitted || "N/A"}</p>
    <p><strong>Date Created:</strong> ${properties.date_created}</p>
  `;
    }

    function checkStatus(status) {
        return ["yes", "y", "na"].includes((status || "").toLowerCase());
    }

    fetch("/static/job_data.geojson")
        .then(response => response.json())
        .then(data => {
            const yearClusterGroups = {};  // Object to hold cluster groups by year
            const completedLayer = L.layerGroup();  // Completed jobs layer (off by default)

            // Process each feature in the GeoJSON data
            L.geoJSON(data, {
                pointToLayer: (feature, latlng) => {
                    let marker;
                    // Check if the job is completed and use the custom icon
                    if (checkStatus(feature.properties.final_plan_submitted)) {
                        marker = L.marker(latlng, {icon: completedIcon}).bindPopup(createPopupContent(feature.properties));
                        completedLayer.addLayer(marker);  // Add completed marker to the completed layer
                    } else {
                        // Create a simple red circle marker for non-completed jobs
                        marker = L.circleMarker(latlng, {
                            radius: 8,
                            fillColor: "#ff0000",
                            color: "#000",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).bindPopup(createPopupContent(feature.properties));
                    }

                    // Extract the year from the date_created property
                    const year = new Date(feature.properties.date_created).getFullYear();

                    // Create a marker cluster group for each year if it doesn't exist
                    if (!yearClusterGroups[year]) {
                        yearClusterGroups[year] = L.markerClusterGroup();  // Initialize marker cluster group for the year
                    }

                    // Add marker to the corresponding year's cluster group
                    yearClusterGroups[year].addLayer(marker);

                    return marker;
                }
            });

            // Add each year's marker cluster group to the map and the control layers
            Object.entries(yearClusterGroups).forEach(([year, clusterGroup]) => {
                map.addLayer(clusterGroup);
                controlLayers.addOverlay(clusterGroup, ` ${year}`);
            });

            // Add completed jobs layer to the control, but keep it off by default
            controlLayers.addOverlay(completedLayer, "Completed Jobs");
        })
        .catch(error => console.error("Error loading job data:", error));


    // Fetch and display monument data
    fetch("/static/pei_control_monuments.geojson")
        .then(response => response.json())
        .then(data => {
            const monumentsLayer = L.layerGroup();

            L.geoJSON(data, {
                pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                    radius: 4,
                    fillColor: "#00bfff",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8,
                }),
            }).addTo(monumentsLayer);

            controlLayers.addOverlay(monumentsLayer, "Monuments");
        })
        .catch(error => console.error("Error loading monument data:", error));

    // Function to check completion status (case-insensitive match)


</script>
</body>
</html>
